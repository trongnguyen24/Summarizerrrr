# Deep Dive Feature Implementation Plan

## 📋 Overview

Tính năng "Deep Dive with AI" cho phép người dùng đào sâu kiến thức sau khi tóm tắt:

- Tự động/thủ công tạo 3 câu hỏi từ LLM
- Chọn câu hỏi gợi ý hoặc nhập câu hỏi tùy chỉnh
- Chọn provider (Gemini/ChatGPT/Perplexity/Grok) để chat
- Tự động mở tab mới và điền form với prompt đã chuẩn bị

---

## 🎯 Technical Specifications

### User Flow

```
Summary Complete
  → Auto/Manual Generate Questions
  → Display UI (sau footer): Question chips + Custom input + Provider selector
  → User selects question/types custom + selects provider
  → Build prompt (mixed approach based on content type)
  → Open new tab with provider
  → Auto-fill form via content script
```

### Content Strategy

- **YouTube/Course videos**: Gửi `summary + link + question` (transcript quá dài)
- **Web articles**: Gửi `original content (max 5000 chars) + summary + link + question`

### Data Management

- ❌ Questions **KHÔNG lưu** vào DB (chỉ tồn tại trong session)
- ❌ Questions **KHÔNG cache** (generate mới mỗi lần)
- ✅ Error handling: Nếu generate fail → chỉ show custom input field

### Settings

- `autoGenerateDeepDiveQuestions` (boolean): Tự động tạo câu hỏi sau summary
- `defaultDeepDiveProvider` (string): Provider mặc định

---

## 📁 Files to Create

### 1. Prompt Templates

**Location**: `src/lib/prompts/`

#### `deepDiveQuestionPrompt.js`

- Export function: `generateDeepDiveQuestionsPrompt(summary, summaryLang)`
- Purpose: Tạo prompt để LLM generate 3 câu hỏi follow-up
- Output format: JSON array `["Q1?", "Q2?", "Q3?"]`

#### `deepDiveContentPrompt.js`

- Export function: `buildDeepDivePrompt({ summary, question, pageTitle, pageUrl, originalContent, contentType })`
- Purpose: Build prompt gửi đến AI provider
- Logic: Nếu YouTube/Course → chỉ summary, nếu Web → thêm original content

### 2. Service Layer

**Location**: `src/services/`

#### `deepDiveService.js`

- Export function: `generateFollowUpQuestions(summary)` → Promise<string[] | null>
- Export function: `openDeepDiveChat({ provider, question, summary, pageTitle, pageUrl, originalContent, contentType })`
- Dependencies:
  - `@/lib/api/aiSdkAdapter.js` - để gọi LLM
  - `@/stores/settingsStore.svelte.js` - lấy settings
  - Prompt templates ở trên

### 3. UI Component

**Location**: `src/components/deepdive/`

#### `DeepDiveSection.svelte`

- All-in-one component chứa:
  - Generate button (nếu chưa có questions)
  - Question chips (hiển thị 3 câu hỏi)
  - Custom question textarea
  - Provider selector dropdown
  - "Start Chat" button
- Props: `{ summary, contentType, originalContent }`
- State: `questions`, `isGenerating`, `isExpanded`, `selectedQuestion`, `customQuestion`, `selectedProvider`
- onMount: Set default provider + auto-generate nếu setting enabled

---

## 🔧 Files to Update

### 1. Settings Store

**File**: `src/stores/settingsStore.svelte.js`

**Changes needed**:

- Add to `DEFAULT_SETTINGS` (around line 8):
  ```javascript
  // Deep Dive Settings
  autoGenerateDeepDiveQuestions: false,
  defaultDeepDiveProvider: 'gemini',
  ```

**Reference files to read**:

- Current file để hiểu structure của DEFAULT_SETTINGS

---

### 2. Background Script

**File**: `src/entrypoints/background.js`

**Changes needed**:

**Part 1**: Add message handlers (insert after line 746, in `browser.runtime.onMessage.addListener`):

```javascript
// Deep Dive message handlers
if (message.type === 'DEEP_DIVE_ON_GEMINI') {
  handleDeepDiveChat('gemini', message.prompt, sendResponse)
  return true
}
if (message.type === 'DEEP_DIVE_ON_CHATGPT') {
  handleDeepDiveChat('chatgpt', message.prompt, sendResponse)
  return true
}
if (message.type === 'DEEP_DIVE_ON_PERPLEXITY') {
  handleDeepDiveChat('perplexity', message.prompt, sendResponse)
  return true
}
if (message.type === 'DEEP_DIVE_ON_GROK') {
  handleDeepDiveChat('grok', message.prompt, sendResponse)
  return true
}
```

**Part 2**: Add helper function (after line 1068, after other helper functions):

```javascript
/**
 * Handle deep dive chat requests
 * @param {string} provider - Provider ID
 * @param {string} prompt - The prompt to send
 * @param {Function} sendResponse - Response callback
 */
async function handleDeepDiveChat(provider, prompt, sendResponse) {
  try {
    const config = aiConfig[provider]
    const tab = await createAITab(provider, config)

    setTimeout(() => {
      sendContentToTab(
        tab.id,
        config.messageType,
        prompt,
        0,
        15,
        provider,
        sendResponse
      )
    }, 2000)
  } catch (error) {
    console.error(`[Background] Deep dive ${provider} error:`, error)
    sendResponse({ success: false, error: error.message })
  }
}
```

**Reference files to read**:

- `src/lib/config/aiConfig.js` - để hiểu structure của aiConfig
- Current file lines 935-1068 - để hiểu pattern của AI service handlers
- Functions: `createAITab()`, `sendContentToTab()` - already exist, reuse them

---

### 3. Footer Display Component

**File**: `src/components/displays/ui/FoooterDisplay.svelte`

**Changes needed**:

- Import `DeepDiveSection` component
- Add props: `contentType`, `originalContent`
- Render `<DeepDiveSection>` **sau** footer buttons section (after line 40)

**Reference files to read**:

- `src/components/displays/core/GenericSummaryDisplay.svelte` - để hiểu cách pass props
- `src/components/displays/platform/YouTubeSummaryDisplay.svelte` - example usage

---

### 4. Summary Settings UI (Optional - can do later)

**File**: TBD - cần xác định file nào hiện đang chứa Summary Settings UI

**Changes needed**:

- Add toggle switch cho `autoGenerateDeepDiveQuestions`
- Add dropdown/select cho `defaultDeepDiveProvider`

**Reference files to read**:

- `src/components/settings/GeneralSettings.svelte` - để hiểu pattern của settings UI
- `src/components/settings/SummarySettings.svelte` (if exists)

---

## 🔍 Reference Files to Read Before Implementation

### Core System Understanding

1. `src/stores/summaryStore.svelte.js` - Hiểu summary state management
2. `src/stores/settingsStore.svelte.js` - Hiểu settings structure
3. `src/lib/api/aiSdkAdapter.js` - Hiểu cách gọi LLM APIs
4. `src/entrypoints/background.js` (lines 935-1068) - Hiểu AI service message handling pattern

### Existing Implementations (for reference)

5. `src/lib/prompts/aiSummaryPrompt.js` - Example prompt structure
6. `src/entrypoints/gemini.content.js` - Example content script (form filling)
7. `src/entrypoints/chatgpt.content.js` - Example content script
8. `src/lib/config/aiConfig.js` - Provider configurations

### UI Patterns

9. `src/components/displays/ui/FoooterDisplay.svelte` - Current footer structure
10. `src/components/displays/core/GenericSummaryDisplay.svelte` - Component prop passing
11. `src/components/settings/GeneralSettings.svelte` - Settings UI patterns

---

## ✅ Implementation Checklist

### Phase 1: Core Services

- [ ] Tạo `src/lib/prompts/deepDiveQuestionPrompt.js`
- [ ] Tạo `src/lib/prompts/deepDiveContentPrompt.js`
- [ ] Tạo `src/services/deepDiveService.js`

### Phase 2: UI Component

- [ ] Tạo `src/components/deepdive/DeepDiveSection.svelte`

### Phase 3: Integration

- [ ] Update `src/stores/settingsStore.svelte.js` (add 2 settings)
- [ ] Update `src/entrypoints/background.js` (add message handlers + helper)
- [ ] Update `src/components/displays/ui/FoooterDisplay.svelte` (integrate component)

### Phase 4: Settings UI (Optional)

- [ ] Add Deep Dive settings to Summary Settings UI

### Phase 5: Testing

- [ ] Test auto-generate questions
- [ ] Test manual generate questions
- [ ] Test custom question input
- [ ] Test with Gemini provider
- [ ] Test with ChatGPT provider
- [ ] Test with Perplexity provider
- [ ] Test with Grok provider
- [ ] Test error handling (generate fail)
- [ ] Test YouTube content type
- [ ] Test web article content type
- [ ] Test course content type

---

## 🎨 UI Mockup

```
┌────────────────────────────────────────────────┐
│ [Summary Content]                               │
│                                                 │
│ ──────────────────────────────────────────────│
│ [Footer: Copy | Download | Save to Archive]    │  ← Existing footer
│ ──────────────────────────────────────────────│
│                                                 │
│ ▸ Dive Deeper 💡                               │  ← Collapsed
│                                                 │
└─────────────────────────────────────────────────┘

┌────────────────────────────────────────────────┐
│ ▾ Dive Deeper 💡                               │  ← Expanded
│                                                 │
│  [✨ Generate Questions]  ← If not generated   │
│                                                 │
│  Select a question or type your own:           │
│                                                 │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐      │
│  │ Question │ │ Question │ │ Question │       │  ← Question chips
│  │    1     │ │    2     │ │    3     │       │
│  └──────────┘ └──────────┘ └──────────┘      │
│                                                 │
│  ┌─────────────────────────────────────────┐  │
│  │ Type your own question...               │  │  ← Custom input
│  └─────────────────────────────────────────┘  │
│                                                 │
│  Chat on: [Gemini ▾]  [💬 Start Chat]        │  ← Provider + Submit
│                                                 │
└─────────────────────────────────────────────────┘
```

---

## 📝 Notes

- Content scripts cho 4 providers đã có sẵn, không cần tạo mới
- Questions không cần lưu vào IndexedDB
- Không cần cache questions trong summaryStore
- Error handling đơn giản: Nếu generate fail → chỉ hiển thị custom input
- i18n translations bỏ qua lần đầu (hardcode English text trước)

---

## 🚀 Ready for Implementation

File này đã sẵn sàng để:

1. Đọc và hiểu toàn bộ kế hoạch
2. Đọc các reference files được liệt kê
3. Tạo phiên chat mới trong Code mode
4. Triển khai từng phase theo checklist
