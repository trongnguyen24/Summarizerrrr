# Deep Dive Feature Implementation Plan

## ğŸ“‹ Overview

TÃ­nh nÄƒng "Deep Dive with AI" cho phÃ©p ngÆ°á»i dÃ¹ng Ä‘Ã o sÃ¢u kiáº¿n thá»©c sau khi tÃ³m táº¯t:

- Tá»± Ä‘á»™ng/thá»§ cÃ´ng táº¡o 3 cÃ¢u há»i tá»« LLM
- Chá»n cÃ¢u há»i gá»£i Ã½ hoáº·c nháº­p cÃ¢u há»i tÃ¹y chá»‰nh
- Chá»n provider (Gemini/ChatGPT/Perplexity/Grok) Ä‘á»ƒ chat
- Tá»± Ä‘á»™ng má»Ÿ tab má»›i vÃ  Ä‘iá»n form vá»›i prompt Ä‘Ã£ chuáº©n bá»‹

---

## ğŸ¯ Technical Specifications

### User Flow

```
Summary Complete
  â†’ Auto/Manual Generate Questions
  â†’ Display UI (sau footer): Question chips + Custom input + Provider selector
  â†’ User selects question/types custom + selects provider
  â†’ Build prompt (mixed approach based on content type)
  â†’ Open new tab with provider
  â†’ Auto-fill form via content script
```

### Content Strategy

- **YouTube/Course videos**: Gá»­i `summary + link + question` (transcript quÃ¡ dÃ i)
- **Web articles**: Gá»­i `original content (max 5000 chars) + summary + link + question`

### Data Management

- âŒ Questions **KHÃ”NG lÆ°u** vÃ o DB (chá»‰ tá»“n táº¡i trong session)
- âŒ Questions **KHÃ”NG cache** (generate má»›i má»—i láº§n)
- âœ… Error handling: Náº¿u generate fail â†’ chá»‰ show custom input field

### Settings

- `autoGenerateDeepDiveQuestions` (boolean): Tá»± Ä‘á»™ng táº¡o cÃ¢u há»i sau summary
- `defaultDeepDiveProvider` (string): Provider máº·c Ä‘á»‹nh

---

## ğŸ“ Files to Create

### 1. Prompt Templates

**Location**: `src/lib/prompts/`

#### `deepDiveQuestionPrompt.js`

- Export function: `generateDeepDiveQuestionsPrompt(summary, summaryLang)`
- Purpose: Táº¡o prompt Ä‘á»ƒ LLM generate 3 cÃ¢u há»i follow-up
- Output format: JSON array `["Q1?", "Q2?", "Q3?"]`

#### `deepDiveContentPrompt.js`

- Export function: `buildDeepDivePrompt({ summary, question, pageTitle, pageUrl, originalContent, contentType })`
- Purpose: Build prompt gá»­i Ä‘áº¿n AI provider
- Logic: Náº¿u YouTube/Course â†’ chá»‰ summary, náº¿u Web â†’ thÃªm original content

### 2. Service Layer

**Location**: `src/services/`

#### `deepDiveService.js`

- Export function: `generateFollowUpQuestions(summary)` â†’ Promise<string[] | null>
- Export function: `openDeepDiveChat({ provider, question, summary, pageTitle, pageUrl, originalContent, contentType })`
- Dependencies:
  - `@/lib/api/aiSdkAdapter.js` - Ä‘á»ƒ gá»i LLM
  - `@/stores/settingsStore.svelte.js` - láº¥y settings
  - Prompt templates á»Ÿ trÃªn

### 3. UI Component

**Location**: `src/components/deepdive/`

#### `DeepDiveSection.svelte`

- All-in-one component chá»©a:
  - Generate button (náº¿u chÆ°a cÃ³ questions)
  - Question chips (hiá»ƒn thá»‹ 3 cÃ¢u há»i)
  - Custom question textarea
  - Provider selector dropdown
  - "Start Chat" button
- Props: `{ summary, contentType, originalContent }`
- State: `questions`, `isGenerating`, `isExpanded`, `selectedQuestion`, `customQuestion`, `selectedProvider`
- onMount: Set default provider + auto-generate náº¿u setting enabled

---

## ğŸ”§ Files to Update

### 1. Settings Store

**File**: `src/stores/settingsStore.svelte.js`

**Changes needed**:

- Add to `DEFAULT_SETTINGS` (around line 8):
  ```javascript
  // Deep Dive Settings
  autoGenerateDeepDiveQuestions: false,
  defaultDeepDiveProvider: 'gemini',
  ```

**Reference files to read**:

- Current file Ä‘á»ƒ hiá»ƒu structure cá»§a DEFAULT_SETTINGS

---

### 2. Background Script

**File**: `src/entrypoints/background.js`

**Changes needed**:

**Part 1**: Add message handlers (insert after line 746, in `browser.runtime.onMessage.addListener`):

```javascript
// Deep Dive message handlers
if (message.type === 'DEEP_DIVE_ON_GEMINI') {
  handleDeepDiveChat('gemini', message.prompt, sendResponse)
  return true
}
if (message.type === 'DEEP_DIVE_ON_CHATGPT') {
  handleDeepDiveChat('chatgpt', message.prompt, sendResponse)
  return true
}
if (message.type === 'DEEP_DIVE_ON_PERPLEXITY') {
  handleDeepDiveChat('perplexity', message.prompt, sendResponse)
  return true
}
if (message.type === 'DEEP_DIVE_ON_GROK') {
  handleDeepDiveChat('grok', message.prompt, sendResponse)
  return true
}
```

**Part 2**: Add helper function (after line 1068, after other helper functions):

```javascript
/**
 * Handle deep dive chat requests
 * @param {string} provider - Provider ID
 * @param {string} prompt - The prompt to send
 * @param {Function} sendResponse - Response callback
 */
async function handleDeepDiveChat(provider, prompt, sendResponse) {
  try {
    const config = aiConfig[provider]
    const tab = await createAITab(provider, config)

    setTimeout(() => {
      sendContentToTab(
        tab.id,
        config.messageType,
        prompt,
        0,
        15,
        provider,
        sendResponse
      )
    }, 2000)
  } catch (error) {
    console.error(`[Background] Deep dive ${provider} error:`, error)
    sendResponse({ success: false, error: error.message })
  }
}
```

**Reference files to read**:

- `src/lib/config/aiConfig.js` - Ä‘á»ƒ hiá»ƒu structure cá»§a aiConfig
- Current file lines 935-1068 - Ä‘á»ƒ hiá»ƒu pattern cá»§a AI service handlers
- Functions: `createAITab()`, `sendContentToTab()` - already exist, reuse them

---

### 3. Footer Display Component

**File**: `src/components/displays/ui/FoooterDisplay.svelte`

**Changes needed**:

- Import `DeepDiveSection` component
- Add props: `contentType`, `originalContent`
- Render `<DeepDiveSection>` **sau** footer buttons section (after line 40)

**Reference files to read**:

- `src/components/displays/core/GenericSummaryDisplay.svelte` - Ä‘á»ƒ hiá»ƒu cÃ¡ch pass props
- `src/components/displays/platform/YouTubeSummaryDisplay.svelte` - example usage

---

### 4. Summary Settings UI (Optional - can do later)

**File**: TBD - cáº§n xÃ¡c Ä‘á»‹nh file nÃ o hiá»‡n Ä‘ang chá»©a Summary Settings UI

**Changes needed**:

- Add toggle switch cho `autoGenerateDeepDiveQuestions`
- Add dropdown/select cho `defaultDeepDiveProvider`

**Reference files to read**:

- `src/components/settings/GeneralSettings.svelte` - Ä‘á»ƒ hiá»ƒu pattern cá»§a settings UI
- `src/components/settings/SummarySettings.svelte` (if exists)

---

## ğŸ” Reference Files to Read Before Implementation

### Core System Understanding

1. `src/stores/summaryStore.svelte.js` - Hiá»ƒu summary state management
2. `src/stores/settingsStore.svelte.js` - Hiá»ƒu settings structure
3. `src/lib/api/aiSdkAdapter.js` - Hiá»ƒu cÃ¡ch gá»i LLM APIs
4. `src/entrypoints/background.js` (lines 935-1068) - Hiá»ƒu AI service message handling pattern

### Existing Implementations (for reference)

5. `src/lib/prompts/aiSummaryPrompt.js` - Example prompt structure
6. `src/entrypoints/gemini.content.js` - Example content script (form filling)
7. `src/entrypoints/chatgpt.content.js` - Example content script
8. `src/lib/config/aiConfig.js` - Provider configurations

### UI Patterns

9. `src/components/displays/ui/FoooterDisplay.svelte` - Current footer structure
10. `src/components/displays/core/GenericSummaryDisplay.svelte` - Component prop passing
11. `src/components/settings/GeneralSettings.svelte` - Settings UI patterns

---

## âœ… Implementation Checklist

### Phase 1: Core Services

- [ ] Táº¡o `src/lib/prompts/deepDiveQuestionPrompt.js`
- [ ] Táº¡o `src/lib/prompts/deepDiveContentPrompt.js`
- [ ] Táº¡o `src/services/deepDiveService.js`

### Phase 2: UI Component

- [ ] Táº¡o `src/components/deepdive/DeepDiveSection.svelte`

### Phase 3: Integration

- [ ] Update `src/stores/settingsStore.svelte.js` (add 2 settings)
- [ ] Update `src/entrypoints/background.js` (add message handlers + helper)
- [ ] Update `src/components/displays/ui/FoooterDisplay.svelte` (integrate component)

### Phase 4: Settings UI (Optional)

- [ ] Add Deep Dive settings to Summary Settings UI

### Phase 5: Testing

- [ ] Test auto-generate questions
- [ ] Test manual generate questions
- [ ] Test custom question input
- [ ] Test with Gemini provider
- [ ] Test with ChatGPT provider
- [ ] Test with Perplexity provider
- [ ] Test with Grok provider
- [ ] Test error handling (generate fail)
- [ ] Test YouTube content type
- [ ] Test web article content type
- [ ] Test course content type

---

## ğŸ¨ UI Mockup

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Summary Content]                               â”‚
â”‚                                                 â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ [Footer: Copy | Download | Save to Archive]    â”‚  â† Existing footer
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                 â”‚
â”‚ â–¸ Dive Deeper ğŸ’¡                               â”‚  â† Collapsed
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â–¾ Dive Deeper ğŸ’¡                               â”‚  â† Expanded
â”‚                                                 â”‚
â”‚  [âœ¨ Generate Questions]  â† If not generated   â”‚
â”‚                                                 â”‚
â”‚  Select a question or type your own:           â”‚
â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Question â”‚ â”‚ Question â”‚ â”‚ Question â”‚       â”‚  â† Question chips
â”‚  â”‚    1     â”‚ â”‚    2     â”‚ â”‚    3     â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Type your own question...               â”‚  â”‚  â† Custom input
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                 â”‚
â”‚  Chat on: [Gemini â–¾]  [ğŸ’¬ Start Chat]        â”‚  â† Provider + Submit
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ Notes

- Content scripts cho 4 providers Ä‘Ã£ cÃ³ sáºµn, khÃ´ng cáº§n táº¡o má»›i
- Questions khÃ´ng cáº§n lÆ°u vÃ o IndexedDB
- KhÃ´ng cáº§n cache questions trong summaryStore
- Error handling Ä‘Æ¡n giáº£n: Náº¿u generate fail â†’ chá»‰ hiá»ƒn thá»‹ custom input
- i18n translations bá» qua láº§n Ä‘áº§u (hardcode English text trÆ°á»›c)

---

## ğŸš€ Ready for Implementation

File nÃ y Ä‘Ã£ sáºµn sÃ ng Ä‘á»ƒ:

1. Äá»c vÃ  hiá»ƒu toÃ n bá»™ káº¿ hoáº¡ch
2. Äá»c cÃ¡c reference files Ä‘Æ°á»£c liá»‡t kÃª
3. Táº¡o phiÃªn chat má»›i trong Code mode
4. Triá»ƒn khai tá»«ng phase theo checklist
