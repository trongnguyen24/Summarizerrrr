\n# FloatingPanel Independent Summarization Implementation Plan\n\n## Overview\nThiết kế và implement function tóm tắt độc lập cho FloatingPanel component, cho phép mỗi tab chạy tóm tắt song song mà không ảnh hưởng đến existing workflow.\n\n## Current System Analysis\n\n### Existing Workflow\n`mermaid\ngraph TD\n    A[Content App] --> B[requestSummary function]\n    B --> C[Send MESSAGE to background.js]\n    C --> D[Background.js processes message]\n    D --> E[Delegates to summaryStore.js]\n    E --> F[fetchAndSummarize function]\n    F --> G[getPageContent from contentService]\n    F --> H[summarizeContent from api.js]\n    H --> I[Update global summaryState]\n    I --> J[FloatingPanel displays from summaryState]\n`\n\n### API Functions Available\n- `summarizeContent(text, contentType)` - Non-streaming\n- `summarizeContentStream(text, contentType)` - Streaming with chunks\n- `summarizeContentStreamEnhanced(text, contentType)` - Enhanced streaming\n\n### Content Service\n- `getPageContent(contentType, preferredLang)` - Extract content from current page\n- Supports: 'webpageText', 'transcript', 'timestampedTranscript'\n- Auto-detects: YouTube videos, Course videos, General webpages\n\n## Architecture Design\n\n### Option Selected: Independent FloatingPanel (Option 1)\n**Lý do chọn:**\n- ✅ Hoàn toàn độc lập với existing workflow\n- ✅ Multi-tab concurrent summarization\n- ✅ Zero conflicts với global summaryState\n- ✅ Scalable và maintainable\n- ✅ User có thể tóm tắt FloatingPanel + SidePanel cùng lúc\n\n### Multi-Tab Independent Workflow\n`mermaid\ngraph TD\n    A[Tab 1 - FloatingPanel] --> B[Local State 1]\n    A --> C[summarizePageContent 1]\n    C --> D[getPageContent → API Call 1]\n    \n    E[Tab 2 - FloatingPanel] --> F[Local State 2] \n    E --> G[summarizePageContent 2]\n    G --> H[getPageContent → API Call 2]\n    \n    I[Tab 3 - FloatingPanel] --> J[Local State 3]\n    I --> K[summarizePageContent 3]\n    K --> L[getPageContent → API Call 3]\n    \n    D -.-> M[All Run Concurrently]\n    H -.-> M\n    L -.-> M\n    \n    N[Side Panel - Global State] --> O[Existing workflow untouched]\n    O -.-> M\n`\n\n## Implementation Plan\n\n### 1. Local State Management\n\n#### FloatingPanel State Structure\n`javascript\nlet localSummaryState = $state({\n  isLoading: false,\n  summary: '',\n  error: null,\n  contentType: 'general', // 'youtube' | 'course' | 'general'\n  startTime: null,\n  streamingEnabled: false\n})\n`\n\n#### State Management Functions\n- `resetLocalSummaryState()` - Reset về trạng thái ban đầu\n- `setLoadingState(isLoading)` - Cập nhật loading state\n- `setSummaryError(error)` - Handle error states\n- `updateSummary(content)` - Cập nhật nội dung summary\n\n### 2. Core Summarization Function\n\n#### Main Function: `summarizePageContent()`\n`javascript\nasync function summarizePageContent() {\n  try {\n    // 1. Reset state\n    resetLocalSummaryState()\n    localSummaryState.isLoading = true\n    localSummaryState.startTime = Date.now()\n\n    // 2. Load settings\n    await loadSettings()\n    \n    // 3. Determine content type and get content\n    const pageContent = await getPageContent('webpageText')\n    localSummaryState.contentType = pageContent.type\n    \n    // 4. Check if streaming is enabled and supported\n    const shouldUseStreaming = settings.enableStreaming && \n      providerSupportsStreaming(settings.selectedProvider)\n    \n    if (shouldUseStreaming) {\n      await summarizeWithStreaming(pageContent.content, pageContent.type)\n    } else {\n      await summarizeWithoutStreaming(pageContent.content, pageContent.type)\n    }\n    \n  } catch (error) {\n    handleSummarizationError(error)\n  } finally {\n    localSummaryState.isLoading = false\n  }\n}\n`\n\n#### Streaming Support\n`javascript\nasync function summarizeWithStreaming(content, contentType) {\n  localSummaryState.streamingEnabled = true\n  const stream = summarizeContentStream(content, contentType)\n  \n  for await (const chunk of stream) {\n    localSummaryState.summary += chunk\n  }\n}\n\nasync function summarizeWithoutStreaming(content, contentType) {\n  const summary = await summarizeContent(content, contentType)\n  localSummaryState.summary = summary\n}\n`\n\n### 3. UI Updates\n\n#### FloatingPanel Template Modifications\n`svelte\n<script>\n  // Existing props\n  let { visible, summary, status, onclose, children } = $props()\n  \n  // NEW: Local summarization state\n  let localSummaryState = $state({\n    isLoading: false,\n    summary: '',\n    error: null,\n    contentType: 'general'\n  })\n  \n  // NEW: Local summarization function\n  async function summarizePageContent() {\n    // Implementation as above\n  }\n  \n  // NEW: Determine which summary to show\n  $derived summaryToDisplay = localSummaryState.summary || summary\n  $derived statusToDisplay = localSummaryState.isLoading ? 'loading' \n    : localSummaryState.error ? 'error' \n    : status\n</script>\n\n<!-- UI shows local summary if available, fallback to global summary -->\n<div class=\"panel-content\">\n  {#if statusToDisplay === 'loading'}\n    <p>Loading... {localSummaryState.isLoading ? '(FloatingPanel)' : ''}</p>\n  {:else if statusToDisplay === 'error'}\n    <p>Error: {localSummaryState.error?.message || 'An error occurred.'}</p>\n  {:else if summaryToDisplay}\n    <div>{@html summaryToDisplay}</div>\n  {:else}\n    <p>No summary available.</p>\n  {/if}\n</div>\n`\n\n#### Action Button Updates\n`svelte\n{#snippet actionButton()}\n  <button onclick={summarizePageContent} disabled={localSummaryState.isLoading}>\n    {localSummaryState.isLoading ? 'Summarizing...' : 'Summarize (FP)'}\n  </button>\n{/snippet}\n`\n\n### 4. Error Handling\n\n#### Comprehensive Error Management\n`javascript\nfunction handleSummarizationError(error) {\n  console.error('[FloatingPanel] Summarization error:', error)\n  \n  localSummaryState.error = {\n    message: error.message || 'Unknown error occurred',\n    type: error.type || 'GENERAL_ERROR',\n    timestamp: Date.now()\n  }\n  \n  // Display user-friendly error messages\n  if (error.type === 'API_KEY') {\n    localSummaryState.error.message = 'API key not configured. Please check settings.'\n  } else if (error.type === 'CONTENT') {\n    localSummaryState.error.message = 'Could not extract content from this page.'\n  } else if (error.type === 'NETWORK') {\n    localSummaryState.error.message = 'Network error. Please check your connection.'\n  }\n}\n`\n\n### 5. Dependencies & Imports\n\n#### Required Imports in FloatingPanel.svelte\n`javascript\nimport { loadSettings, settings } from '@/stores/settingsStore.svelte.js'\nimport { getPageContent } from '@/services/contentService.js'\nimport { \n  summarizeContent, \n  summarizeContentStream,\n  providerSupportsStreaming \n} from '@/lib/api/api.js'\n`\n\n## Implementation Steps\n\n### Phase 1: Core Function Implementation\n1. ✅ Analyze existing API and workflow\n2. ✅ Design independent architecture\n3. ⏳ **Next: Add local state management to FloatingPanel**\n4. ⏳ Implement `summarizePageContent()` function\n5. ⏳ Add error handling and loading states\n\n### Phase 2: UI Integration\n6. ⏳ Update FloatingPanel template for local summary display\n7. ⏳ Add \"Summarize\" button in actionButton snippet\n8. ⏳ Implement loading indicators and error displays\n\n### Phase 3: Testing & Optimization\n9. ⏳ Test single tab summarization\n10. ⏳ Test multi-tab concurrent summarization\n11. ⏳ Verify no conflicts with existing workflow\n12. ⏳ Test streaming vs non-streaming modes\n13. ⏳ Performance optimization and cleanup\n\n## Benefits\n\n### Multi-Tab Concurrent Summarization\n- **Tab 1:** FloatingPanel tóm tắt Wikipedia article\n- **Tab 2:** Fl
