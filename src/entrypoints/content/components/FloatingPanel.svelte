<script>
  // @ts-nocheck
  import { onMount, onDestroy } from 'svelte'

  // Import composables
  import Icon from '@iconify/svelte'
  import SummarizeButton from '@/components/buttons/SummarizeButton.svelte'
  import { useNavigationManager } from '../composables/useNavigationManager.svelte.js'
  import { useSummarization } from '../composables/useSummarization.svelte.js'
  import { useFloatingPanelState } from '../composables/useFloatingPanelState.svelte.js'
  import { settings, updateSettings } from '@/stores/settingsStore.svelte.js'
  import { useApiKeyValidation } from '../composables/useApiKeyValidation.svelte.js'
  import ApiKeySetupPrompt from '@/components/ui/ApiKeySetupPrompt.svelte'
  import { fade } from 'svelte/transition'
  import FloatingPanelContent from '@/components/displays/floating-panel/FloatingPanelContent.svelte'
  import ActionButtonsFP from '@/components/buttons/ActionButtonsFP.svelte'
  import ActionButtonsMiniFP from '@/components/buttons/ActionButtonsMiniFP.svelte'

  let panelPosition = $derived(settings.floatingPanelLeft ? 'left' : 'right')
  let { visible, summary, status, onclose, children, summarization } = $props()

  let panelElement = $state()
  let isResizing = $state(false)
  let currentWidthPx = $state(0) // Will be set in loadWidth()
  let showElement = $state(false) // Internal state để control DOM rendering
  const navigationManager = useNavigationManager()
  const { needsApiKeySetup } = useApiKeyValidation()
  let unsubscribeNavigation = null

  async function requestSummary() {
    console.log('Requesting page summary...')
    try {
      const response = await browser.runtime.sendMessage({
        type: 'REQUEST_SUMMARY',
        payload: {
          url: window.location.href,
        },
        // For page summary, we assume type is 'pageSummary'
        type: 'pageSummary',
      })
      console.log('Summary request response:', response)
    } catch (error) {
      console.error('Failed to request summary:', error)
    }
  }

  function openSettings() {
    browser.runtime.sendMessage({ type: 'OPEN_SETTINGS' })
  }

  function openArchive() {
    browser.runtime.sendMessage({ type: 'OPEN_ARCHIVE' })
  }

  function handleSummarizeClick() {
    summarization.summarizePageContent()
  }

  async function handleCustomAction(actionType) {
    console.log(`[FloatingPanel] Executing custom action: ${actionType}`)
    if (actionType === 'chapters') {
      await summarization.summarizeChapters()
    } else {
      await summarization.summarizePageContent(actionType)
    }
  }

  // Detect if current page is YouTube
  let isYouTubeActive = $derived(() => {
    const url = window.location.href
    return /youtube\.com\/watch/i.test(url)
  })
  function togglePanelPosition() {
    updateSettings({ floatingPanelLeft: !settings.floatingPanelLeft })
  }
  // Constants in px units
  const MIN_WIDTH_PX = 380 // 380px
  const MAX_WIDTH_PX = 860 // 860px

  // Helper functions to convert between em and px
  function emToPx(em) {
    try {
      const rootFontSize = parseFloat(
        getComputedStyle(document.documentElement).fontSize
      )
      // Fallback to 16px if root font size cannot be determined
      const fontSize = isNaN(rootFontSize) ? 16 : rootFontSize
      return em * fontSize
    } catch (error) {
      console.warn(
        'Failed to get root font size, using 16px as fallback:',
        error
      )
      return em * 16 // Fallback to 16px
    }
  }

  function pxToEm(px) {
    const rootFontSize = parseFloat(
      getComputedStyle(document.documentElement).fontSize
    )
    return px / rootFontSize
  }

  // Initialize composables
  const panelState = useFloatingPanelState()

  // Computed properties để determine what to display
  let summaryToDisplay = $derived(summarization.summaryToDisplay() || summary)
  let statusToDisplay = $derived(
    summarization.localSummaryState().isLoading
      ? 'loading'
      : summarization.localSummaryState().error
        ? 'error'
        : status
  )

  // Load saved width
  async function loadWidth() {
    try {
      const data = await browser.storage.local.get('sidePanelWidthPx')
      const savedWidthPx = data.sidePanelWidthPx // Saved width is in px units
      if (
        savedWidthPx &&
        savedWidthPx >= MIN_WIDTH_PX &&
        savedWidthPx <= MAX_WIDTH_PX
      ) {
        currentWidthPx = savedWidthPx
        if (panelElement) {
          panelElement.style.width = `${savedWidthPx}px`
        }
      } else {
        // Set default width if no saved width or invalid saved width
        currentWidthPx = Math.max(
          MIN_WIDTH_PX,
          Math.min(emToPx(settings.sidePanelDefaultWidth), MAX_WIDTH_PX)
        )
        if (panelElement) {
          panelElement.style.width = `${currentWidthPx}px`
        }
      }
    } catch (error) {
      console.warn('Failed to load width, using default:', error)
      // Fallback to default width on error
      currentWidthPx = Math.max(
        MIN_WIDTH_PX,
        Math.min(emToPx(settings.sidePanelDefaultWidth), MAX_WIDTH_PX)
      )
      if (panelElement) {
        panelElement.style.width = `${currentWidthPx}px`
      }
    }
  }

  // Save current width
  async function saveWidth() {
    try {
      await browser.storage.local.set({ sidePanelWidthPx: currentWidthPx }) // Save in px units
    } catch (error) {
      console.warn('Failed to save width:', error)
    }
  }

  // Resize logic
  function handleResizeStart(event) {
    if (!panelElement) return

    isResizing = true
    document.body.style.userSelect = 'none'
    // Prevent text selection and other browser behaviors
    event.preventDefault()

    // Get clientX from either mouse or touch event
    const getClientX = (e) => {
      if (e.type.startsWith('touch')) {
        return e.touches[0].clientX
      }
      return e.clientX
    }

    // Store initial mouse position và current panel width in px
    const startMouseX = getClientX(event)
    const startWidthPx = currentWidthPx

    const handleMove = (e) => {
      if (!isResizing) return

      const currentMouseX = getClientX(e)
      let newWidthPx

      if (panelPosition === 'right') {
        // Panel bên phải: kéo trái = tăng width, kéo phải = giảm width
        const deltaX = startMouseX - currentMouseX
        newWidthPx = startWidthPx + deltaX
      } else {
        // Panel bên trái: kéo phải = tăng width, kéo trái = giảm width
        const deltaX = currentMouseX - startMouseX
        newWidthPx = startWidthPx + deltaX
      }

      // Validate width in px
      if (newWidthPx >= MIN_WIDTH_PX && newWidthPx <= MAX_WIDTH_PX) {
        currentWidthPx = newWidthPx
        panelElement.style.width = newWidthPx + 'px'
      }
    }

    const handleEnd = () => {
      isResizing = false
      document.body.style.userSelect = ''
      document.removeEventListener('mousemove', handleMove)
      document.removeEventListener('mouseup', handleEnd)
      document.removeEventListener('touchmove', handleMove)
      document.removeEventListener('touchend', handleEnd)
      saveWidth()
    }

    // Add event listeners for both mouse and touch
    document.addEventListener('mousemove', handleMove)
    document.addEventListener('mouseup', handleEnd)
    document.addEventListener('touchmove', handleMove, { passive: false })
    document.addEventListener('touchend', handleEnd)
  }

  // Keyboard handler
  function handleKeyDown(event) {
    if (visible && event.key === 'Escape') {
      onclose?.()
    }
  }

  // Effect để handle visible state changes với smooth animation
  $effect(() => {
    if (visible) {
      // Show element first, then animate in
      showElement = true
      setTimeout(() => {
        if (panelElement && currentWidthPx > 0) {
          panelElement.style.width = `${currentWidthPx}px`
          panelElement.classList.add('visible')
        }
      }, 10)
    } else {
      // Animate out first, then hide element
      if (panelElement) {
        panelElement.classList.remove('visible')
        // Wait for animation to complete before hiding DOM
        setTimeout(() => {
          showElement = false
        }, 410) // Match CSS transition duration
      } else {
        showElement = false
      }
    }
  })

  onMount(() => {
    loadWidth()
    window.addEventListener('keydown', handleKeyDown)
    document.addEventListener('summarizeClick', handleSummarizeClick)

    // Subscribe vào navigation changes
    unsubscribeNavigation = navigationManager.subscribe(handleUrlChange)
  })

  function handleUrlChange(newUrl) {
    // Khi URL thay đổi, reset state của component
    console.log('FloatingPanel: URL changed to', newUrl)
    // Có thể thêm logic để reset state cụ thể ở đây nếu cần
  }

  onDestroy(() => {
    window.removeEventListener('keydown', handleKeyDown)
    document.removeEventListener('summarizeClick', handleSummarizeClick)
    document.body.style.userSelect = ''

    // Cleanup navigation subscription
    if (unsubscribeNavigation) {
      unsubscribeNavigation()
    }
  })
</script>

{#if showElement}
  <!-- svelte-ignore a11y_click_events_have_key_events -->
  <!-- svelte-ignore a11y_no_static_element_interactions -->
  <div
    class="backdrop"
    onclick={() => {
      if (settings.closePanelOnOutsideClick) {
        onclose?.()
      }
    }}
  ></div>
  <!-- Sidepanel container -->
  <div
    class="floating-panel pt-8"
    class:left={panelPosition === 'left'}
    class:right={panelPosition === 'right'}
    bind:this={panelElement}
    role="dialog"
    aria-modal="true"
    tabindex="-1"
    style="width: {currentWidthPx}px"
  >
    {#if !settings.hasCompletedOnboarding}
      <div
        class="absolute z-[10001] inset-0"
        in:fade={{ duration: 300 }}
        out:fade={{ duration: 300 }}
      >
        {#await import('@/components/welcome/WelcomeFlow.svelte')}
          <div
            class="welcome-loading-container absolute z-50 bg-surface-1 inset-0 flex items-center justify-center"
          ></div>
        {:then { default: WelcomeFlow }}
          <div
            class="absolute max-h-svh z-[99] inset-0 flex items-center justify-center"
          >
            <WelcomeFlow shadow={true} />
          </div>
        {:catch error}
          <div
            class="welcome-error-container absolute z-50 bg-surface-1 inset-0 flex items-center justify-center"
          >
            <p class="text-red-500">
              Error loading welcome flow: {error.message}
            </p>
          </div>
        {/await}
      </div>
    {/if}
    <!-- Resize handle -->
    <!-- svelte-ignore a11y_no_noninteractive_element_interactions -->
    <div
      class="resize-handle bg-transparent transition-colors flex justify-center items-center"
      class:left={panelPosition === 'left'}
      class:right={panelPosition === 'right'}
      class:resizing={isResizing}
      onmousedown={handleResizeStart}
      ontouchstart={handleResizeStart}
      role="separator"
      aria-orientation="vertical"
      aria-label="Resize panel"
      title="Drag to resize panel width"
    >
      <span class="w-2.5 h-12 text-white dark:text-border">
        <svg
          viewBox="0 0 10 48"
          fill="currentColor"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            class=" stroke-border"
            d="M9.5 5.20703V42.793L5 47.293L0.5 42.793V5.20703L5 0.707031L9.5 5.20703Z"
            fill="currentColor"
            stroke="black"
          />
        </svg>
      </span>
    </div>
    <!-- svelte-ignore a11y_consider_explicit_label -->
    <button
      onclick={togglePanelPosition}
      class="close-button absolute text-muted z-[99] border-r border-border hover:text-text-primary transition-colors w-14 duration-200 cursor-pointer h-8 top-0 left-0 flex justify-center items-center"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="20"
        viewBox="0 0 24 24"
        class="{panelPosition === 'left'
          ? '-scale-x-100'
          : ''} delay-200 transition-transform duration-300"
      >
        <g fill="none" stroke="currentColor" stroke-width="2">
          <path
            d="M2 11c0-3.771 0-5.657 1.172-6.828S6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172S22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828S17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172S2 16.771 2 13z"
          />
          <path stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3" />
        </g>
      </svg>
    </button>
    <button
      onclick={() => onclose?.()}
      class="close-button absolute text-muted z-[98] border-b border-border bg-blackwhite-10 dark:bg-surface-2 hover:text-text-primary transition-colors duration-200 cursor-pointer h-8 top-0 right-0 left-0 flex justify-center items-center"
      aria-label="Close"
      ><Icon
        icon="heroicons:arrow-long-right"
        class=" {panelPosition === 'left' ? '-scale-x-100' : ''}"
        width="24"
        height="24"
      /></button
    >
    <div id="shadow-scroll" class="w-full h-full overflow-y-auto">
      <div class="grid grid-rows-[10px_200px_10px_1fr] relative">
        <div
          class="top-stripes border-b border-border flex justify-center items-center w-full h-full"
        ></div>
        <div class="w-full flex items-center justify-center my-8">
          <button
            class="size-10 absolute cursor-pointer z-10 top-3 text-text-secondary hover:text-text-primary transition-colors left-2 flex justify-center items-center"
            onclick={openArchive}
            title="Open Archive"
          >
            <Icon icon="solar:history-linear" width="24" height="24" />
          </button>
          <button
            class="size-10 absolute cursor-pointer z-10 top-3 text-text-secondary hover:text-text-primary transition-colors right-2 flex justify-center items-center"
            onclick={openSettings}
          >
            <Icon width={24} icon="heroicons:cog-6-tooth" />
          </button>
          {#if !needsApiKeySetup()()}
            <SummarizeButton
              isLoading={summarization.localSummaryState().isLoading}
              isChapterLoading={summarization.localSummaryState()
                .isChapterLoading}
            />
          {/if}
          {#if summaryToDisplay || summarization.localSummaryState().error}
            <ActionButtonsMiniFP
              onActionClick={handleCustomAction}
              isYouTubeActive={isYouTubeActive()}
            />
          {/if}
        </div>
        <div
          class="top-stripes border-t border-b border-border flex justify-center items-center w-full h-full"
        ></div>
      </div>

      {#if needsApiKeySetup()()}
        <div class="px-4 pt-8">
          <ApiKeySetupPrompt />
        </div>
      {:else}
        <FloatingPanelContent
          status={statusToDisplay}
          summary={summaryToDisplay}
          error={summarization.localSummaryState().error}
          contentType={summarization.localSummaryState().contentType}
          chapterSummary={summarization.localSummaryState().chapterSummary}
          isChapterLoading={summarization.localSummaryState().isChapterLoading}
          courseConcepts={summarization.localSummaryState().courseConcepts}
          isCourseSummaryLoading={summarization.localSummaryState().isLoading}
          isCourseConceptsLoading={summarization.localSummaryState()
            .isCourseConceptsLoading}
          activeYouTubeTab={panelState.activeYouTubeTab()}
          activeCourseTab={panelState.activeCourseTab()}
          onSelectYouTubeTab={panelState.setActiveYouTubeTab}
          onSelectCourseTab={panelState.setActiveCourseTab}
          {summarization}
        />
      {/if}

      {#if !summaryToDisplay && !summarization.localSummaryState().isLoading && !needsApiKeySetup()()}
        <ActionButtonsFP
          onActionClick={handleCustomAction}
          isYouTubeActive={isYouTubeActive()}
        />
      {/if}

      {#if children?.settingsMini}
        {@render children.settingsMini()}
      {/if}
    </div>
  </div>
{/if}

<style>
  /* Sidepanel Main Container */
  .floating-panel {
    position: fixed;
    top: 0;
    height: 100vh;
    width: 25em; /* Default width in em units */
    background-color: var(--color-surface-1);
    font-size: 16px;
    display: flex;
    flex-direction: column;
    z-index: 2147483641;
    color: var(--color-text-primary);
    border-left: 1px solid var(--color-border);
    border-right: 1px solid var(--color-border);
    transition: transform 0.4s cubic-bezier(0.4, 0.71, 0.45, 1);
    box-sizing: border-box;
  }

  .floating-panel.right {
    right: 0;
    transform: translateX(100%);
  }

  .floating-panel.left {
    left: 0;
    transform: translateX(-100%);
  }

  /* Resize Handle */
  .resize-handle {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 0.5em;
    cursor: col-resize;
    flex-shrink: 0;
    z-index: 10000;
  }

  .resize-handle.right {
    left: 0;
    transform: translateX(-50%);
  }

  .resize-handle.left {
    right: 0;
    transform: translateX(50%);
  }

  /* Active state khi đang resize */
  .resize-handle.resizing {
    background-color: oklch(50% 0 0 / 0.175) !important;
  }

  /* Backdrop */
  .backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: transparent;
    z-index: 2147483640;
  }
  .resize-handle.resizing {
    background-color: oklch(50% 0 0 / 0.175) !important;
  }
  .backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: transparent;
    z-index: 2147483640;
  }
</style>
